function scroll(){$("#capanel .textbox").scrollTop($("#capanel .textbox").prop("scrollHeight"))}function showAddBtn(){console.log("showAddBtn"),$(".addGroup").show()}function showCancelBtn(){console.log("showCancelBtn"),$(".cancelGroup").show()}function hideAddBtn(){console.log("hideAddBtn"),$(".addGroup").hide()}function hideCancelBtn(){console.log("hideCancelBtn"),$(".cancelGroup").hide()}function loadPanel(){$("head").append("    <style>        /* Chattr Stylesheet */        #capanel *{            box-sizing:border-box;            margin:0;        }        #capanel{ /* Main Panel */            font-family:helvetica;            font-size:12px;            position:fixed;            width:250px; /* static for now */            height:400px;            background:#F6F6F6;            border:1px solid #c6c6c6;            color:#191a1c;            padding:0;            box-sizing:border-box;            bottom:10px;            left:10px;            z-index:100;        }        #capanel .top{            padding:5px 0;        }        #capanel .bottom{            text-align:center;            bottom: 5px;            position: absolute;        }        #capanel .textbox{            border:1px solid #DBDBDB;            background:#fefefe;            margin: 0px 10px 5px;            height:50%;            position:relative;            overflow-y: scroll;        }        #capanel .button{            border:1px solid #DBDBDB;            color:#191a1c;            padding:3px 5px;            border-radius:5px;            background:#fefefe;            text-decoration:none;        }        #capanel .textarea{            width: 100%;            background: #fff;            border-top: 1px solid #C6C6C6;            border-bottom: 1px solid #C6C6C6;            border-left: transparent;            border-right: transparent;            height: 40px;            font-family:helvetica;            padding:3px 5px;            margin: 0 0 5px;        }        #capanel .input{            width: 100%;            background: #fff;            border-top: 1px solid #C6C6C6;            border-bottom: 1px solid #C6C6C6;            border-left: transparent;            border-right: transparent;            padding:3px 5px;        }        #capanel .textbox li{            border-bottom:1px solid #DBDBDB;            padding:3px 5px;            list-style:none;        }        #capanel .textbox li:nth-child(even){            background:#FCFCFC;        }        #capanel .user{            float:left;            font-weight:bold;            text-transform: capitalize;        }        #capanel .time{            float:right;            font-style: italic;        }         #capanel .out{            clear:both;            word-wrap: break-word;        }        #capanel-toggle{            border:1px solid #DBDBDB;            color:#191a1c;            padding:3px 5px;            border-radius:5px;            background:#fefefe;            text-decoration:none;            position: fixed;            bottom: 10px;            left: 10px;            box-shadow: 0 0 2px 1px rgba(50,250,155,0.3);            cursor: pointer;            z-index:100;            user-select: none;            -moz-user-select: none;        }        #capanel .selectUsers{            margin-left: 9px;            text-transform: capitalize;        }        #capanel .drops, #capanel .group{            margin-left: 10px;            clear:both;        }        #capanel .group{            margin-bottom:9px;            font-weight:bold;            float:left;        }        #capanel .selectGroups, #capanel .selectUsers{            max-width:60%;        }        #capanel #close{            float:right;            position: absolute;            right: 0;            top:0;        }        #capanel #enlarge, #capanel #shrink{            position: absolute;            right: 25px;            top: 0;        }        #capanel .nameChange .out{            font-size: 10px;            color: rgba(15, 146, 15, 1);        }        #capanel .groupTitle .out{            color: rgba(15, 146, 15, 1);            font-weight: bold;        }        #capanel .userLeave .out{            color: rgba(146, 103, 15, 1);            font-size: 10px;        }        #capanel .userJoined .out{            color: rgba(0, 111, 255, 1);            font-size: 10px;        }        </style>    "),$("body").append('        <div id="capanel">            <div class="top">                    <div class="group">Current Group: </div>                    <input type="text" class="input" maxlength="20" id="addGroupInput" placeholder="New Group Name"/>                    <button type="button" id="enlarge" class="button" title="enlarge">[+]</button>                    <button type="button" id="shrink" class="button" title="shrink">[-]</button>                <button type="button" id="close" class="button" title="close">X</button>                <div class="drops">                Groups:                <select class="button selectGroups">                    <option style="display:none"></option>                </select>                <button type="button" class="button addGroup" title="add group">Add</button>                <button type="button" class="button cancelGroup" title="cancel group">Cancel</button>                <br/>Users:                <select class="button selectUsers">                    <option style="display:none"></option>                </select>                </div>            </div>            <div class="textbox"></div>            <div class="bottom">                <form>                    <input id="capanel-name" type="text" class="input" placeholder="Name" maxlength="20"/>                    <input type="text" id="capanel-text" class="textarea" placeholder="Message" maxlength="1024"></textarea>                                        <input type="file" id="fileSelect" style="display:none;"/>                    <input class="button" type="button" name="file" value="Upload..." style="background:rgba(195, 195, 195, 1);" onclick="document.getElementById(\'fileSelect\').click();" readonly/>                    <input id="capanel-submit" class="button" type="button" value="Send"/>                </form>            </div>        </div> <!-- #capanel -->    '),$("body").append('        <div class="button chat-button" id="capanel-toggle">            + Chat        </div>    '),scroll()}function newDate(a){var b=new Date(a);b.getFullYear();var d=b.getMonth()+1,e=b.getDate(),f=b.getHours(),g=b.getMinutes(),h=b.getSeconds();return d=10>d?"0"+d:""+d,e=10>e?"0"+e:""+e,f=10>f?"0"+f:""+f,g=10>g?"0"+g:""+g,h=10>h?"0"+h:""+h,a=d+"/"+e+" - "+f+":"+g}function getMessageId(a){return a.name().replace(/[^a-z0-9\-\_]/gi,"")}function getId(a){return a.name()}function showMessages(a){a.limit(50).on("child_added",function(a){var b=a.val();if("changedName"==b.name)$('<li class="nameChange"/>').attr("id",getMessageId(a)).append($('<div class="out"/>').text(b.text)).appendTo($("#capanel .textbox"));else if("Chattr!"==b.name)$('<li class="groupTitle"/>').attr("id",getMessageId(a)).append($('<div class="out"/>').text(b.text)).appendTo($("#capanel .textbox"));else if("userLeft"==b.name)$('<li class="userLeave"/>').attr("id",getMessageId(a)).append($('<div class="out"/>').text(b.text)).appendTo($("#capanel .textbox"));else if("userJoin"==b.name)$('<li class="userJoined"/>').attr("id",getMessageId(a)).append($('<div class="out"/>').text(b.text)).appendTo($("#capanel .textbox"));else{var c=newDate(b.time),d=Autolinker.link(b.text);$("<li/>").attr("id",getMessageId(a)).append($('<div class="user"/>').text(b.name).attr("title",b.name)).append($('<div class="time"/>').text(c).attr("title",b.time)).append($('<div class="out"/>').html(d)).appendTo($("#capanel .textbox"))}scroll()})}function defaultMessage(a,b){a.once("value",function(c){null===c.val()&&a.push({name:"Chattr!",text:"Welcome to the "+b+" group!"}),console.log("added a default message to: "+b)})}function send(a){var b=$("#capanel-name").val();if(""==b&&$("#capanel-name").val("Anonymous"),b!=fbUserName){console.log("send() updated username: "+fbUserName+" to: "+b);var c=fbUserName+" changed their name to "+b;fbUser.update({name:b}),a.push({name:"changedName",text:c,time:Date.now()}),fbUsers.off(),$(".select-user").remove(),listUsers()}var d=$("#capanel-text").val();a.push({name:fbUserName,text:d,time:Date.now()}),$("#capanel-text").val(""),console.log("Sending message..."),scroll()}function listUsers(){fbUsers.on("child_added",function(a){console.log("listUsers()");var b=a.val();$('<option class="select-user"/>').attr("id",getMessageId(a)).text(b.name).appendTo($("#capanel .selectUsers"))})}function lastUser(a){1==cnt&&(idName=getId(a),fbUser=new Firebase(firebaseURL+"/users/"+idName),fbUser.onDisconnect().remove(function(){$("#"+idName).remove()}),console.log("deleteLAST:"+idName),cnt=1e4),console.log(++cnt),setTimeout(function(){console.log(cnt+":250"),1==cnt&&(idName=getId(a),fbUser=new Firebase(firebaseURL+"/users/"+idName),fbUser.onDisconnect().remove(function(){$("#"+idName).remove()}),console.log("deleteONE:"+idName),cnt=1e4)},1500)}function bindEvents(){$("#capanel-text").keypress(function(a){13==a.keyCode&&send(fb)}),$("#capanel-submit").click(function(){send(fb)}),$("#capanel #enlarge").click(function(){$("#capanel").css("width","350px"),$("#capanel").css("height","500px"),$("#capanel .textbox").css("height","60%"),$("#capanel #enlarge").hide(),$("#capanel #shrink").show()}),$("#capanel #shrink").click(function(){$("#capanel").removeAttr("style"),$("#capanel").removeAttr("style"),$("#capanel .textbox").removeAttr("style"),$("#capanel #enlarge").show(),$("#capanel #shrink").hide()}),$("#capanel #close").click(function(){$("#capanel").hide(),$("#capanel-toggle").show()}),$(".cancelGroup").click(function(){console.log(".cancelGroup was clicked"),cancelGroup(group)}),$(".addGroup").click(function(){console.log("add group btn clicked, groupCurrent: "+group),hideGroup(),hideAddBtn(),$("#addGroupInput").show(),showCancelBtn(),$("#addGroupInput").keypress(function(a){13==a.keyCode?(hideCancelBtn(),createGroup(fbGroups)):27==a.keyCode&&cancelGroup(group)}),scroll()})}function hideAddGroupInput(){console.log("hideAddGroupInput"),$("#addGroupInput").hide()}function hideGroup(){console.log("hideGroup"),$(".group").hide()}function showGroup(a){$("#currentGroup").remove(),$(".group").show(),$('<span id="currentGroup"/>').text(a).appendTo($(".group")),console.log("show group: "+a)}function createGroup(){console.log("creating group?"),""==$("#addGroupInput").val()||(group=$("#addGroupInput").val(),group=group.replace(/\ /g,"_"),group=group.replace(/\./g,"-"),hideAddGroupInput(),fb.off(),Firebase.goOffline(),fb=new Firebase(firebaseURL+"/groups/"+group),$(".textbox li").remove(),hideGroup(),console.log("Created a Group: "+group),showGroup(group),Firebase.goOnline(),showMessages(fb),defaultMessage(fb,group),showAddBtn()),scroll()}function cancelGroup(a){hideCancelBtn(),hideAddGroupInput(),console.log("cancelGroup: "+a),showGroup(a),showAddBtn()}function clickGroup(){console.log("clicking exsisting group: "+$(this).val()),group=$(this).val(),$(".textbox li").remove(),hideGroup(),showAddBtn(),hideAddGroupInput(),hideCancelBtn(),fb.off(),Firebase.goOffline(),fb=new Firebase(firebaseURL+"/groups/"+group),Firebase.goOnline(),showMessages(fb),showGroup(group),defaultMessage(fb,group),scroll()}function loadDependency(a,b){var c=document.createElement("script");c.src=a,c.async=!0,c.onreadystatechange=c.onload=function(){console.log("script loaded");var a=c.readyState;b.done||a&&!/loaded|complete/.test(a)||(b.done=!0,b())},document.getElementsByTagName("head")[0].appendChild(c)}function loadFirebase(){console.log("loadFirebase: loading firebase"),loadDependency("https://cdn.firebase.com/js/client/1.0.15/firebase.js",loadAutolinker)}function loadAutolinker(){console.log("loadAutolinker: loading autolinker"),loadDependency("https://raw.githubusercontent.com/gregjacobs/Autolinker.js/0.11.2/dist/Autolinker.min.js",dependCallback)}function injectDependencies(){"$"in window?loadFirebase():(console.log("injectDependencies: loading jquery"),loadDependency("https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js",loadFirebase))}function loadChattr(){loadPanel(),bindEvents(),$("#shrink").hide(),$("#capanel").hide(),$("#capanel-toggle").click(function(){$("#capanel").toggle(),$("#capanel-toggle").toggle(),scroll()});var a=$("#capanel-name").val();console.log("Using url: "+firebaseURL),fbGroups=new Firebase(firebaseURL+"/groups");var b="default";fb=new Firebase(firebaseURL+"/groups/"+b),""===a||void 0===a?(username="Anonymous",console.log("set anon name.."),$("#capanel-name").val("Anonymous")):(username=a,console.log("use last cached name..")),fbUsers=new Firebase(firebaseURL+"/users/"),fbUsers.push({name:username}),fbUsers.endAt().limit(1).on("child_added",lastUser),setTimeout(function(){console.log("fbUser: "+fbUser.toString()),fbUser.on("value",function(a){fbUserName=a.val().name,console.log("setTimeOut: fbUserName is: "+fbUserName),listUsers()}),fb.push({name:"userJoin",text:fbUserName+" joined the chat",time:newDate()}),scroll()},2e3),fbUsers.on("child_removed",function(a){var b=$(".selectUsers").children("#"+getMessageId(a));console.log(fbUserName+" left chattr..."),fb.push({name:"userLeft",text:fbUserName+" left the chat",time:newDate()}),b.remove()}),$("#addGroupInput").hide(),$(".cancelGroup").hide(),showMessages(fb),showGroup(b),defaultMessage(fb,b),showAddBtn(),scroll(),fbGroups.on("child_added",function(a){$("<option/>").attr("id",getMessageId(a)).text(getMessageId(a)).appendTo($("#capanel .selectGroups")),scroll()}),$(".selectGroups").change(clickGroup)}function dependCallback(){loadChattr()}function entry(){yourURL=window.location.hostname.replace(/\./g,"-"),firebaseURL="https://chatappcd.firebaseio.com/"+yourURL+"/chat",injectDependencies()}var cnt=0;entry();